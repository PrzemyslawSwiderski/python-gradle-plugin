name: ☃️ Post Release Updates

on:
  workflow_call:
    inputs:
      release-version:
        required: true
        type: string

jobs:
  post-release-updates:
    name: Post Release Updates
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Print version
        run: echo "Post-release job for version ${{ inputs.release-version }}"

      # Check out current repository
      - name: Fetch Sources
        uses: actions/checkout@v5

      # Update Samples Version to newly published one
      - name: Update Samples Version
        run: |
          VERSION="${{ inputs.release-version }}"
          sed -i "s/pluginVersionForExamples.*/pluginVersionForExamples=$VERSION/g" gradle.properties

      # Create a pull request
      - name: Create Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ inputs.release-version }}"
          BRANCH="chore/post-release-update-$VERSION"
          LABEL="post release update"

          git config user.email "action@github.com"
          git config user.name "GitHub Action"

          git checkout -b $BRANCH
          git commit -am "Post release update - $VERSION"
          git push --set-upstream origin $BRANCH

          gh label create "$LABEL" \
            --description "Pull requests with post release updates" \
            --force \
            || true

          # Create PR and capture URL
          PR_URL=$(gh pr create \
            --title "Post release update - \`$VERSION\`" \
            --body "Current pull request contains patched files for the \`$VERSION\` version." \
            --label "$LABEL" \
            --head $BRANCH)

          echo "Created PR at $PR_URL"

          # Auto-merge PR (using squash method)
          gh pr merge --auto --squash --delete-branch "$PR_URL"
